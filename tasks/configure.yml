---
- name: Merge Sensu configs
  sensu_merge:
    suffix: _sensu_{{ item }}
    var_name: sensu_{{ item }}
  with_items:
    - checks
    - handlers
    - filters
    - mutators

- name: Configure Sensu
  copy:
    dest: "{{ sensu_config_file }}"
    content: "{{ sensu_config | to_nice_json }}\n"
    owner: "{{ sensu_user }}"
    group: "{{ sensu_group }}"
    mode: 0600
    validate: "{{ sensu_bin }}/sensu-server -c '%s' --validate_config"
  notify:
    - restart sensu-server
    - restart sensu-api
    - restart sensu-client
